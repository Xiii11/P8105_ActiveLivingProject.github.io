---
title: "Model Analysis"
output: 
  html_document:
    toc: false
    toc_float: true
    theme: lumen
    code_folding: hide
---

Load packages and import cleaned dataframes.
```{r, message = FALSE, warning = FALSE}
library(ggridges)
library(tidyverse)
library(plotly)
library(gridExtra)
library(reshape2)
library(mediation)
library(dplyr)

commuting_df = read.csv("data/commuting.csv", na = c("NA",".","")) |> 
  janitor::clean_names() |> 
  rename(geo_type = geo_type_desc) |> 
  filter(
    geo_type %in% c("UHF 42", "Citywide", "Borough"))

overweight_overall_df = read_csv("data/overweightoverall.csv", na = c("NA",".","")) |> 
  janitor::clean_names() |> 
  rename(
    obs_number = number,
    obs_percent = percent
  ) |> 
  separate(
    obs_percent, 
    into = c("obs_percent", "obs_percent_range"), 
    sep = "\\s*\\(\\s*", 
    convert = TRUE
  ) |>
  mutate(obs_percent_range = str_remove(obs_percent_range, "\\)$"))

sidewalk_df = read_csv("data/sidewalk.csv", na = c("NA",".","")) |> 
  janitor::clean_names() |> 
  mutate(neighborhood_geo_id = paste(geography, geo_id, sep = ", ")) 

commuting_sidewalk_df = 
  inner_join(commuting_df, sidewalk_df, by = c("geo_id", "geo_rank", "geography")) |> 
  dplyr::select(-time_period.x, -time_period.y, everything()) |> 
  mutate(
    bicycle_info = paste0(bicycle_number, " (", bicycle_percent, "%)"),
    car_truck_van_info = paste0(car_truck_or_van_number, " (", car_truck_or_van_percent, "%)"),
    public_transport_info = paste0(public_transportation_number, " (", public_transportation_percent, "%)"),
    walked_info = paste0(walked_number, " (", walked_percent, "%)")
  )
```

## **Association between sidewalk areas and the percentage of walking among commuters **
```{r, message = FALSE, warning = FALSE}
side_walking_data <- commuting_sidewalk_df |> 
  dplyr::select(geography, percent_of_land_area, walked_percent) |> 
  mutate(
    walked_percent = as.numeric(walked_percent),
    percent_of_land_area = as.numeric(percent_of_land_area)
  ) |> 
  filter(!is.na(walked_percent) & !is.na(percent_of_land_area))  

lm_model = lm(walked_percent ~ percent_of_land_area, data = side_walking_data)
lm_summary = summary(lm_model)

detailed_model_table = data.frame(
  Statistic = c(
    "Intercept Estimate", "Intercept Std. Error", "Intercept t-value", "Intercept p-value",
    "Slope Estimate (percent_of_land_area)", "Slope Std. Error", "Slope t-value", "Slope p-value",
    "Residual Std. Error", "R-squared", "Adjusted R-squared", "F-statistic", "F-statistic p-value"
  ),
  Value = c(
    lm_summary$coefficients[1, "Estimate"],
    lm_summary$coefficients[1, "Std. Error"],
    lm_summary$coefficients[1, "t value"],
    lm_summary$coefficients[1, "Pr(>|t|)"],
    lm_summary$coefficients[2, "Estimate"],
    lm_summary$coefficients[2, "Std. Error"],
    lm_summary$coefficients[2, "t value"],
    lm_summary$coefficients[2, "Pr(>|t|)"],
    lm_summary$sigma,
    lm_summary$r.squared,
    lm_summary$adj.r.squared,
    lm_summary$fstatistic[1],
    pf(
      lm_summary$fstatistic[1],
      lm_summary$fstatistic[2],
      lm_summary$fstatistic[3],
      lower.tail = FALSE
    )
  )
)

library(ggplot2)
ggplot(commuting_sidewalk_df, aes(x = percent_of_land_area, y = walked_percent)) +
  geom_point() +
  geom_smooth(method = "lm", color = "skyblue1") +
  labs(title = "Relationship between Sidewalk Area and Walking Commuters", font = 7,
       x = "Sidewalk Area Percentage",
       y = "Walking Commuters Percentage") +
  theme_minimal()


coefficients_q3 <- coef(lm_model)
equation_q3 <- paste0(
  "$$ \\text{Walking Commuters Percentage} = \\beta_0 + \\beta_1 \\cdot \\text{Sidewalk Area Percentage} \\\\",
  "\\beta_0 = ", round(coefficients_q3[1], 3), ", \\beta_1 = ", round(coefficients_q3[2], 3), " $$"
)

cat(equation_q3)

knitr::kable(detailed_model_table,caption = "Detailed Linear Model Summary")

```

### Conclusion
#### The linear model indicates a significant positive relationship between the percentage of land area allocated to sidewalks and the percentage of commuters who walk. The slope coefficient of <b>1.9624</b> suggests that for every 1% increase in sidewalk area, the proportion of walking commuters increases by approximately 1.96 percentage points. The adjusted R-squared value (<b>0.408</b>) demonstrates that the model explains about 40.8% of the variability in walking commuter rates.

<hr style="height: 5px; border: none; background: linear-gradient(to right, lightblue, white);">

## **Influence of sidewalk areas and walking commuters on obesity rates **
```{r, message = FALSE, warning = FALSE}
sw_obs_data = overweight_overall_df |> 
  filter(time_period %in% c(2014, 2022)) |> 
  mutate(obs_percent = as.numeric(gsub("\\*|\\(|\\)", "", obs_percent))) |> 
  dplyr::select(geo_id, geography, obs_percent) |> 
  inner_join(commuting_sidewalk_df, by = c("geo_id", "geography")) |> 
  dplyr::select(geography, percent_of_land_area, walked_percent, obs_percent) |> 
  mutate(
    walked_percent = as.numeric(walked_percent),
    percent_of_land_area = as.numeric(percent_of_land_area),
    obs_percent = as.numeric(obs_percent)
  ) |> 
  filter(!is.na(walked_percent) & !is.na(percent_of_land_area) & !is.na(obs_percent)) 

lm_model_obesity = lm(obs_percent ~ percent_of_land_area + walked_percent, data = sw_obs_data)
lm_summary_obesity = summary(lm_model_obesity)

detailed_model_table_obesity <- data.frame(
  Statistic = c(
    "Intercept Estimate",
    "Intercept Std. Error",
    "Intercept t-value",
    "Intercept p-value",
    "Sidewalk Area Slope Estimate",
    "Sidewalk Area Slope Std. Error",
    "Sidewalk Area Slope t-value",
    "Sidewalk Area Slope p-value",
    "Walking Commuters Slope Estimate",
    "Walking Commuters Slope Std. Error",
    "Walking Commuters Slope t-value",
    "Walking Commuters Slope p-value",
    "Residual Std. Error",
    "R-squared",
    "Adjusted R-squared",
    "F-statistic",
    "F-statistic p-value"
  ),
  Value = c(
    lm_summary_obesity$coefficients[1, "Estimate"],
    lm_summary_obesity$coefficients[1, "Std. Error"],
    lm_summary_obesity$coefficients[1, "t value"],
    lm_summary_obesity$coefficients[1, "Pr(>|t|)"],
    lm_summary_obesity$coefficients[2, "Estimate"],
    lm_summary_obesity$coefficients[2, "Std. Error"],
    lm_summary_obesity$coefficients[2, "t value"],
    lm_summary_obesity$coefficients[2, "Pr(>|t|)"],
    lm_summary_obesity$coefficients[3, "Estimate"],
    lm_summary_obesity$coefficients[3, "Std. Error"],
    lm_summary_obesity$coefficients[3, "t value"],
    lm_summary_obesity$coefficients[3, "Pr(>|t|)"],
    lm_summary_obesity$sigma,
    lm_summary_obesity$r.squared,
    lm_summary_obesity$adj.r.squared,
    lm_summary_obesity$fstatistic[1],
    pf(
      lm_summary_obesity$fstatistic[1],
      lm_summary_obesity$fstatistic[2],
      lm_summary_obesity$fstatistic[3],
    )
  )
)

sw_obs_data_plot = 
  ggplot(sw_obs_data, aes(x = percent_of_land_area, y = obs_percent, color = walked_percent)) +
  geom_point(size = 3, alpha = 0.7) +
  geom_smooth(method = "lm", formula = y ~ x + walked_percent, 
              color = "skyblue1", linetype = "solid", size = 1) + 
  labs(
    title = "Influence of Sidewalk Areas and Walking Commuters on Obesity Rates",
    x = "Sidewalk Area Percentage",
    y = "Obesity Percentage",
    color = "Walking Commuters Percentage"
  ) +
  theme_minimal()

ggplotly(sw_obs_data_plot)

coefficients_q4 <- coef(lm_model_obesity)
equation_q4 <- paste0(
  "$$ \\text{Obesity Percentage} = \\beta_0 + \\beta_1 \\cdot \\text{Sidewalk Area Percentage} + \\beta_2 \\cdot \\text{Walking Commuters Percentage} \\\\",
  "\\beta_0 = ", round(coefficients_q4[1], 3), ", \\beta_1 = ", round(coefficients_q4[2], 3), ", \\beta_2 = ", round(coefficients_q4[3], 3), " $$"
)

cat(equation_q4)

knitr::kable(
  detailed_model_table_obesity,
  caption = "Detailed Linear Model Summary for Obesity Rates"
)
```

### Conclusion:
#### While both sidewalk area percentage and walking commuter rates are modeled as predictors of obesity rates, only walking commuter rates show a statistically significant relationship. This highlights the importance of promoting active commuting as a means to potentially reduce obesity rates. The model indicates that encouraging walking as a commute mode may have a measurable impact on public health outcomes.



## **Interaction Analysis**
#### Next, we are curious whether there are **interaction effects** between sidewalk area percentage and walking commuter rates on obesity rates. To test this, an interaction model was built to explore whether the effect of sidewalk area percentage on obesity depends on walking commuter rates.

```{r, message = FALSE, warning = FALSE}
# Run the interaction model
lm_interaction <- lm(obs_percent ~ percent_of_land_area * walked_percent, data = sw_obs_data)

# Summarize the model
interaction_summary <- summary(lm_interaction)
```

The coefficients from the interaction model are summarized in the following table:
```{r, message = FALSE, warning = FALSE}
# Extract interaction model parameters
interaction_results <- data.frame(
  Estimate = interaction_summary$coefficients[, "Estimate"],
  `Std. Error` = interaction_summary$coefficients[, "Std. Error"],
  `t-value` = interaction_summary$coefficients[, "t value"],
  `p-value` = interaction_summary$coefficients[, "Pr(>|t|)"]
)

# Display the interaction model results
knitr::kable(
  interaction_results,
  caption = "Interaction Analysis Results",
  digits = 3
)

```

The results indicate that the interaction term (percent_of_land_area:walked_percent) is not statistically significant (p = 0.932), suggesting that the relationship between sidewalk area percentage and obesity rates does not depend on walking commuter rates. This implies that sidewalk area percentage and walking commuter rates **operate independently** in influencing obesity outcomes.


## Visualizing the Interaction Effects
To better understand the potential interaction, we created a plot that categorizes walking commuter rates into four levels: Low, Moderate, High, and Very High. Each category is represented by a distinct color, with regression lines and shaded confidence intervals illustrating the relationship between sidewalk area percentage and obesity rates for each category.
```{r, message = FALSE, warning = FALSE}
# Create categories for walking commuter rates
sw_obs_data$walked_percent_category <- cut(
  sw_obs_data$walked_percent,
  breaks = c(-Inf, 5, 10, 15, Inf), # Define categories
  labels = c("Low", "Moderate", "High", "Very High")
)

# Updated plot with categories, confidence intervals, and labels
ggplot(sw_obs_data, aes(x = percent_of_land_area, y = obs_percent, color = walked_percent_category)) +
  geom_point(size = 2, alpha = 0.8) + # Add points
  geom_smooth(method = "lm", aes(group = walked_percent_category), se = TRUE, linetype = "solid") + # Add regression lines with confidence intervals
  scale_color_manual(
    values = c("Low" = "blue", "Moderate" = "darkgreen", "High" = "orange", "Very High" = "red"),
    name = "Walking Commuter Category"
  ) + # Custom colors for walking categories
  labs(
    title = "Interaction Effect Between Sidewalk Area and Walking Commuter Rates on Obesity",
    x = "Sidewalk Area Percentage",
    y = "Obesity Rates (%)"
  ) +
  theme_minimal() +
  theme(
    legend.position = "right", # Place legend on the right
    legend.title = element_text(size = 12, face = "bold"), # Style legend title
    legend.text = element_text(size = 10) # Style legend text
  )

```


# Results and Insights
The plot illustrates the interaction between sidewalk area percentage and obesity rates across four categories of walking commuter rates. Regression lines for each category are relatively flat and similar in slope, indicating that the relationship between sidewalk area percentage and obesity rates does not vary meaningfully with walking commuter rates. The confidence intervals overlap substantially, reinforcing the statistical finding of a non-significant interaction effect.

Together, the plot and the interaction analysis table confirm that there is no significant interaction between sidewalk area percentage and walking commuter rates on obesity rates. While walking commuter rates and sidewalk area percentage may independently contribute to obesity outcomes, their combined effect does not exhibit meaningful synergy. Future research could investigate other potential mediators or moderators, such as socioeconomic status or access to recreational infrastructure, to better understand the determinants of obesity in urban settings.



## **Testing for Mediation: Walking Commuter Rates as a Mediator**

We now explore whether walking commuter rates **mediate** the relationship between sidewalk area percentage and obesity rates. Mediation analysis helps determine if the effect of sidewalk area percentage on obesity rates operates indirectly through walking commuter rates.


```{r, message = FALSE, warning = FALSE}
# mediator model
mediator_model <- lm(walked_percent ~ percent_of_land_area, data = sw_obs_data)
# outcome model
outcome_model <- lm(obs_percent ~ percent_of_land_area + walked_percent, data = sw_obs_data)

mediation_result <- mediate(
  model.m = mediator_model,
  model.y = outcome_model,
  treat = "percent_of_land_area",
  mediator = "walked_percent",
  boot = TRUE, # Use bootstrapping for CI
  sims = 1000  # Number of bootstrap simulations=1000
)
```


```{r, message = FALSE, warning = FALSE}
mediation_results <- data.frame(
  Effect = c("ACME (Indirect Effect)", "ADE (Direct Effect)", "Total Effect", "Proportion Mediated"),
  Estimate = c(mediation_result$d0, mediation_result$z0, mediation_result$tau.coef, mediation_result$n0),
  `CI Lower` = c(mediation_result$d0.ci[1], mediation_result$z0.ci[1], mediation_result$tau.ci[1], mediation_result$n0.ci[1]),
  `CI Upper` = c(mediation_result$d0.ci[2], mediation_result$z0.ci[2], mediation_result$tau.ci[2], mediation_result$n0.ci[2]),
  `p-value` = c(mediation_result$d0.p, mediation_result$z0.p, mediation_result$tau.p, mediation_result$n0.p)
)

knitr::kable(
  mediation_results,
  caption = "Mediation Analysis Results",
  digits = 3
)
```


```{r, message = FALSE, warning = FALSE}
effects_data <- data.frame(
  Effect = c("ACME (Indirect Effect)", "ADE (Direct Effect)", "Total Effect"),
  Estimate = c(mediation_result$d0, mediation_result$z0, mediation_result$tau.coef),
  CI_Lower = c(mediation_result$d0.ci[1], mediation_result$z0.ci[1], mediation_result$tau.ci[1]),
  CI_Upper = c(mediation_result$d0.ci[2], mediation_result$z0.ci[2], mediation_result$tau.ci[2])
)

ggplot(effects_data, aes(x = Effect, y = Estimate)) +
  geom_bar(stat = "identity", fill = "skyblue", alpha = 0.8) +
  geom_errorbar(aes(ymin = CI_Lower, ymax = CI_Upper), width = 0.2, color = "black") +
  labs(
    title = "Decomposition of Total Effect: Mediation Analysis",
    x = "Effect Type",
    y = "Effect Estimate"
  ) +
  theme_minimal()

```

The mediation analysis demonstrates that walking commuter rates __significantly mediate__ the relationship between sidewalk area percentage and obesity rates. 

The __Average Causal Mediation Effect (ACME)__ is statistically significant (estimate: -0.910, 95% CI: [-1.476, -0.439], p < 0.001), indicating that for every unit increase in sidewalk area percentage, obesity rates decrease by approximately 0.91 units through walking behavior. This highlights walking as a critical pathway through which sidewalk infrastructure reduces obesity.

The __Average Direct Effect (ADE)__ is not significant, suggesting that sidewalk area percentage does not independently impact obesity rates outside of its influence on walking. However, the __Total Effect__ is significant, with a 1.54-unit decrease in obesity rates for every unit increase in sidewalk area percentage. Approximately 59% of this total effect is mediated by walking, emphasizing the role of walking commuter behavior in linking sidewalk coverage to public health outcomes.

These findings highlight the potential of urban planning strategies, such as increasing sidewalk coverage, to promote walking and reduce obesity rates. While sidewalk area alone may not directly reduce obesity, its role in fostering environments that encourage active commuting is pivotal. Policymakers should prioritize pedestrian-friendly infrastructure alongside initiatives to promote walking, addressing public health challenges like obesity while supporting broader urban health goals.